# CPU-only Dockerfile for Demo Deployment
# Lightweight version without GPU dependencies for VPS demo

FROM python:3.10-slim

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies (minimal)
RUN apt-get update && apt-get install -y \
    git \
    wget \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Create working directory
WORKDIR /app

# Create non-root user for security
RUN useradd --create-home --shell /bin/bash appuser

# Copy requirements and install Python dependencies (CPU versions)
COPY requirements-demo.txt requirements.txt
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu && \
    pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . .

# Create necessary directories
RUN mkdir -p data/raw data/processed data/dataset data/docs_for_rag data/test \
             results models notebooks ui screenshots database/init

# Create demo mode flag and mock data
RUN echo "DEMO_MODE=true" > /app/.env && \
    echo "USE_GPU=false" >> /app/.env

# Set proper permissions
RUN chown -R appuser:appuser /app

# Switch to non-root user
USER appuser

# Environment variables for demo
ENV STREAMLIT_SERVER_PORT=8501
ENV STREAMLIT_SERVER_ADDRESS=0.0.0.0
ENV STREAMLIT_SERVER_HEADLESS=true
ENV STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
ENV DEMO_MODE=true
ENV USE_GPU=false

# Health check
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8501/_stcore/health || exit 1

# Expose port
EXPOSE 8501

# Create demo startup script
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "🎭 Starting Financial QA System - DEMO MODE"\n\
echo "CPU Only Deployment for UI Demo"\n\
echo "GPU Available: false (Demo Mode)"\n\
\n\
# Create mock model directories for demo\n\
mkdir -p models/Llama-3.1-8B-Instruct\n\
mkdir -p models/mxbai-embed-large-v1\n\
mkdir -p models/llama31-financial-qa-merged\n\
\n\
# Create mock config files\n\
echo "{\"demo\": true}" > models/Llama-3.1-8B-Instruct/config.json\n\
echo "{\"demo\": true}" > models/mxbai-embed-large-v1/config.json\n\
echo "{\"demo\": true}" > models/llama31-financial-qa-merged/config.json\n\
\n\
# Create sample data files\n\
echo "{\\"financial_qa_pairs\\": [{\\"instruction\\": \\"What is a demo?\\", \\"output\\": \\"This is a demo version\\"}]}" > data/dataset/financial_qa_finetune.json\n\
echo "[{\\"instruction\\": \\"Demo question\\", \\"output\\": \\"Demo answer\\"}]" > data/test/comprehensive_qa.json\n\
\n\
# Start Streamlit\n\
echo "🌐 Starting Streamlit Demo on port 8501"\n\
streamlit run app.py --server.port=8501 --server.address=0.0.0.0\n\
' > /app/start-demo.sh && chmod +x /app/start-demo.sh

# Default command
CMD ["/app/start-demo.sh"]

# Labels for demo version
LABEL maintainer="Financial QA System - Demo"
LABEL description="CPU-only demo version for UI showcase"
LABEL version="1.0-demo"
LABEL gpu.required="false"
